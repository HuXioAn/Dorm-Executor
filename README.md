# Dorm-Executor

> 基于ESP32单片机，通过WIFI、BLE控制空调、灯光、房门的执行器。
>
> 基于我个人宿舍需求，修改后可支持更多的设备、场景。
>
> 2022\4\6:
>
> 格力空调的BLE小程序控制、QQ机器人控制。

更多功能在不断探索中。。。

---

## 工程说明

仓库中目前有两个ESP-IDF 4.4工程，其功能大致相似。

`ESP32-IRremote-Gree`是仅有蓝牙BLE控制的版本，通过微信小程序即可控制空调。

`ESP32-IRremote-WIFI-BLE`是结合WIFI与BLE的版本，在有可用WIFI时将会**优先**使用WiFi+MQTT+QQ控制，在遇到WIFI、MQTT服务器问题并重试无果后将会切换BLE，并定时重新检查WIFI是否可用。

关于WiFi与BLE模式切换的流程将会在后文讨论，后期预计会加入模式动态选择功能。

## 红外遥控

### 编码

网络上各种空调编码的教程、项目分享的非常多，但是我试了很久都没成功，所以。。。我拆了一个遥控器并用逻辑分析仪把格力空调的编码抓了出来。和网上的教程大致相同，但**正是细微的不同导致遥控失败**，所以在使用时最好结合实际情况和机型。

由于我寝室使用的是格力空调，目前发送编码仅有这一品牌，同时生成编码的函数功能我只保留了我认为常用的一些功能，有需要的朋友可以自行拓展，后续有需求也可以继续完善。

**关于编码格式的详细内容以及逻辑分析仪波形图片都会在文章里详细讲述。**

### 程序实现

各个工程使用的都是相同的源文件`gree.c`与头文件`gree.h`。

他们提供了层层包装的函数来完成不同级别的调用，其他应用程序可以直接调用最抽象的发送函数并输入需求字符串，即可完成红外遥控，也可以按需调用二进制码生成、红外码生成、红外RMT发送等分步函数。

由以下函数组成：

- `generate_gree_cmd`按照温度、模式等参数生成由01组成的序列
- `generate_gree_item`将上一个函数生成的二进制码转换为RMT所需要的items序列
- `level_implement`被上一个函数所调用的内联函数，用于填充items
- `send_gree`包装了前三个函数并发送红外码，在内部初始化RMT、发送item序列、卸载RMT
- `remote_control`接收字符串并解析调用`send_gree`

**起始码、连接码、各类电平的持续时间、红外LED所在IO口等等遥控相关参数都可以在`gree.h`的宏定义修改。**

## 连接模式

### 蓝牙BLE

### WIFI

### 切换策略

## 用户控制方案

### BLE

### WIFI\MQTT\QQ

